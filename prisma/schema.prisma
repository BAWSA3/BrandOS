generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  supabaseId    String    @unique    // Links to Supabase Auth
  email         String?   @unique    // Optional - for account recovery
  xUsername     String               // Required - from X OAuth
  xId           String    @unique    // X user ID
  name          String?
  avatar        String?
  isInnerCircle Boolean   @default(false)
  invitedBy     String?              // Username who invited them
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  brands       Brand[]
  teamMembers  TeamMember[]
  sharedBrands SharedBrand[]
  feedback     Feedback[]

  @@index([xUsername])
}

model Brand {
  id        String   @id @default(cuid())
  name      String
  colors    String   // JSON string
  tone      String   // JSON string
  keywords  String   // JSON array string
  doPatterns String  // JSON array string
  dontPatterns String // JSON array string
  voiceSamples String // JSON array string
  voiceFingerprint String? // JSON string of VoiceFingerprint
  isPublic  Boolean  @default(false)
  shareToken String? @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Team access
  team      Team?    @relation(fields: [teamId], references: [id])
  teamId    String?

  // Shared access
  sharedWith SharedBrand[]
  
  // History
  history   HistoryEntry[]

  // Health Snapshots
  healthSnapshots BrandHealthSnapshot[]

  // Synced X tweets
  tweets BrandTweet[]

  // Content calendar drafts
  contentDrafts ContentDraft[]

  // Drift alerts
  driftAlerts DriftAlert[]

  @@index([userId])
  @@index([teamId])
  @@index([shareToken])
}

model Team {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  members   TeamMember[]
  brands    Brand[]
}

model TeamMember {
  id        String   @id @default(cuid())
  role      String   @default("member") // "owner", "admin", "member", "viewer"
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
}

model SharedBrand {
  id         String   @id @default(cuid())
  permission String   @default("view") // "view", "edit"
  createdAt  DateTime @default(now())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  brandId    String
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@index([brandId])
}

model BrandHealthSnapshot {
  id              String   @id @default(cuid())
  overallScore    Int      // Composite 0-100
  completeness    Int      // Sub-dimension 0-100
  consistency     Int      // Sub-dimension 0-100
  voiceMatch      Int      // Sub-dimension 0-100
  engagement      Int      // Sub-dimension 0-100
  activity        Int      // Sub-dimension 0-100
  trendDirection  String   // "up", "down", "stable"
  trendDelta      Int      // Absolute delta from previous
  computationData String   // JSON audit trail of raw inputs
  periodStart     DateTime
  periodEnd       DateTime
  createdAt       DateTime @default(now())

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([createdAt])
  @@index([brandId, createdAt])
}

model BrandTweet {
  id              String   @id @default(cuid())
  tweetId         String   @unique        // X tweet ID (dedup key)
  text            String
  postedAt        DateTime               // When tweet was posted on X
  metrics         String                 // JSON: {likes, retweets, replies, impressions, quotes}
  entities        String?                // JSON: {hashtags, mentions, urls}
  alignmentScore  Int?                   // 0-100, null = not yet scored
  engagementRate  Float?                 // Computed: (likes+RTs+replies)/impressions
  brandId         String
  brand           Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  syncedAt        DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([brandId, postedAt(sort: Desc)])
}

model HistoryEntry {
  id          String   @id @default(cuid())
  type        String   // "check" or "generate"
  input       String
  output      String   // JSON string
  contentType String?
  score       Int?
  createdAt   DateTime @default(now())

  brandId     String
  brand       Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([createdAt])
}

// Newsletter signup for early access
model EmailSignup {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("landing") // where they signed up from
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// Invite codes for Inner Circle referrals
model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  createdBy   String    // X username of creator
  maxUses     Int       @default(3)
  usedCount   Int       @default(0)
  usedBy      String    @default("[]") // JSON array of usernames
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  isActive    Boolean   @default(true)

  @@index([code])
  @@index([createdBy])
}

// ===== RESEARCH AGENT MODELS =====

model ResearchRun {
  id          String    @id @default(cuid())
  status      String    @default("pending") // pending, running, completed, failed
  verticals   String    // JSON array of verticals covered
  sources     String    // JSON array of sources used
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  topicsFound Int       @default(0)
  error       String?

  // Owner
  userId  String
  brandId String?

  // Relationships
  topics ResearchTopic[]

  @@index([userId])
  @@index([brandId])
  @@index([startedAt])
}

model ResearchTopic {
  id              String   @id @default(cuid())
  title           String
  summary         String
  vertical        String   // pokemon, mtg, yugioh, sports-cards, collectibles
  category        String   // news, trend, controversy, product-launch, price-alert
  relevanceScore  Int      @default(50) // 0-100
  sentimentScore  Int?     // -100 to 100
  engagementLevel String?  // low, medium, high, viral

  // Source data
  sources  String // JSON array of source references
  keywords String  // JSON array of extracted keywords
  hashtags String? // JSON array of related hashtags
  mentions String? // JSON array of mentioned accounts/products

  // Timing
  trendingPeriod String?  // last-24h, last-week, last-month
  firstSeen      DateTime @default(now())
  lastUpdated    DateTime @default(now())
  expiresAt      DateTime?

  // Relationships
  researchRunId String
  researchRun   ResearchRun      @relation(fields: [researchRunId], references: [id], onDelete: Cascade)
  selections    TopicSelection[]

  @@index([vertical])
  @@index([category])
  @@index([relevanceScore])
  @@index([firstSeen])
}

model TopicSelection {
  id         String   @id @default(cuid())
  status     String   @default("selected") // selected, in-progress, content-generated, dismissed
  selectedAt DateTime @default(now())

  // Content generation tracking
  contentTypes   String? // JSON array of content types to generate
  generatedCount Int     @default(0)

  // Relationships
  topicId String
  topic   ResearchTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  userId  String
  brandId String?

  @@unique([topicId, userId])
  @@index([userId])
  @@index([status])
}

model ResearchSourceConfig {
  id          String    @id @default(cuid())
  name        String    @unique // twitter, reddit, youtube, serper
  enabled     Boolean   @default(true)
  apiStatus   String    @default("unknown") // healthy, degraded, down, unknown
  lastChecked DateTime?
  config      String?   // JSON config (rate limits, etc.)

  @@index([enabled])
}

// ===== CONTENT CALENDAR =====

model ContentDraft {
  id           String    @id @default(cuid())
  content      String
  contentType  String    @default("tweet") // tweet, thread, poll, hot-take, educational, counter-argument, story
  tone         String    @default("casual")
  status       String    @default("idea") // idea, draft, scheduled, published
  scheduledFor DateTime?
  sourceType   String?   // idea-feed, manual, repurpose
  sourceId     String?   // ID of the parent draft (for repurpose chain)
  authenticity Int?      // 0-100 from fingerprint pipeline
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  // Self-referential repurpose chain
  parentId String?
  parent   ContentDraft?  @relation("RepurposeChain", fields: [parentId], references: [id], onDelete: SetNull)
  children ContentDraft[] @relation("RepurposeChain")

  @@index([brandId])
  @@index([brandId, status])
  @@index([brandId, scheduledFor])
  @@index([parentId])
}

// ===== FEEDBACK SYSTEM =====

model Feedback {
  id          String   @id @default(cuid())
  userId      String?  // Optional - allow anonymous feedback
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type        String   // 'bug', 'idea', 'other', 'nps', 'feature_request'
  category    String?  // 'score_journey', 'brand_dna', 'agents', 'ui', 'performance'
  message     String
  rating      Int?     // 1-5 stars or 0-10 NPS
  url         String?  // Page where feedback was given
  metadata    String?  // JSON - browser, screen size, etc.
  status      String   @default("new") // 'new', 'reviewed', 'in_progress', 'resolved', 'wont_fix'
  priority    String?  // 'low', 'medium', 'high', 'critical'
  adminNotes  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

// ===== BRAND DRIFT ALERTS =====

model DriftAlert {
  id            String   @id @default(cuid())
  type          String   // "dimension_drop", "low_alignment", "overall_drop"
  severity      String   // "critical", "warning"
  metric        String   // which dimension dropped, or "overall"
  previousScore Int
  currentScore  Int
  delta         Int      // absolute drop amount
  message       String   // human-readable description
  status        String   @default("new") // "new", "dismissed"
  createdAt     DateTime @default(now())

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([brandId, status])
  @@index([createdAt])
}

